name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ------------------------------------------------------------------
  # BACKEND JOBS (Go)
  # ------------------------------------------------------------------
  backend-lint:
    name: Backend Lint (golangci-lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: false
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: backend
          args: --timeout=5m --config=.golangci.yaml

  api-lint:
    name: API Lint (Spectral)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install Spectral
        run: npm install -g @stoplight/spectral-cli
      - name: Lint OpenAPI Spec
        working-directory: backend
        run: spectral lint docs/openapi.yaml --ruleset .spectral.yaml

  backend-test:
    name: Backend Test (Go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - name: Test with Coverage
        working-directory: backend
        run: go test -v -coverprofile=coverage.out -race ./...
      - name: Coverage Report
        working-directory: backend
        run: go tool cover -func=coverage.out

  backend-build:
    name: Backend Build (Go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - name: Build
        working-directory: backend
        run: go build -o backend-app main.go

  # ------------------------------------------------------------------
  # SECURITY AUDIT (TASK-176: Dependency Vulnerability Scanning)
  # ------------------------------------------------------------------
  backend-security:
    name: Backend Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - name: Run govulncheck
        working-directory: backend
        run: govulncheck ./...
      - name: Run gosec
        uses: securego/gosec@master
        with:
          args: -exclude=G104 ./backend/...

  frontend-security:
    name: Frontend Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - name: Install Dependencies
        working-directory: frontend
        run: npm ci
      - name: npm audit
        working-directory: frontend
        run: npm audit --audit-level=high || true
        # || true to not fail CI on advisory-only issues

  # ------------------------------------------------------------------
  # FRONTEND JOBS (Next.js / Node)
  # ------------------------------------------------------------------
  frontend-lint:
    name: Frontend Lint (ESLint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - name: Install Dependencies
        working-directory: frontend
        run: npm ci
      - name: Lint
        working-directory: frontend
        run: npm run lint

  frontend-build:
    name: Frontend Build (Next.js)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - name: Install Dependencies
        working-directory: frontend
        run: npm ci
      - name: Build
        working-directory: frontend
        run: npm run build

  # ------------------------------------------------------------------
  # FRONTEND TESTS (TASK-169)
  # ------------------------------------------------------------------
  # frontend-test:
  #     name: Frontend Test (Vitest)
  #     runs-on: ubuntu-latest
  #     needs: [frontend-lint]
  #     steps:
  #         - uses: actions/checkout@v4
  #         - name: Setup Node.js
  #           uses: actions/setup-node@v4
  #           with:
  #               node-version: "20"
  #               cache: "npm"
  #               cache-dependency-path: frontend/package-lock.json
  #         - name: Install Dependencies
  #           working-directory: frontend
  #           run: npm ci
  #         - name: Test
  #           working-directory: frontend
  #           run: npx vitest run --coverage
